<!DOCTYPE html5>

<html>
    <head>
        <title>wikidraw</title>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/bootstrap.min.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/bootstrap-responsive.min.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/wikidraw.css")">
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/bootstrap.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/raphael-min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/underscore-min.js")" type="text/javascript"></script>
    </head>
    <body>
    	<div class="row-fluid">
			<div class="span6">
				<h4>edit</h4>
<textarea id="edit">
` 안녕하세요, prepare

* 안녕하세요, activity

< 안녕하세요, input

< 안녕하세요, output
</textarea>
		    </div>
			<div class="span6">
		    	<h4>preview</h4>
				<div id='preview'></div>
		    </div>
		</div>
		<div class="row-fluid">
<h4>github issues</h4>
<ul id='issues'>
</ul>
		</div>
		
		<script language="javascript">
$('#edit').on('input', function(event) {
	render(event.currentTarget.value)
})

var paper = Raphael('preview');
var unit = 15;
var arrowunit = 8;
var fontsize = 16;
var shapeY = 40
var centerX = paper.width / 2
var centerY = paper.height / 2

function render(wikitext) {
	wikitext = wikitext.split("\\n").join('\n').trim()
	// reset paper
	paper.clear();

	// generate each shapes
	var shapes = _.map(wikitext.split('\n'), function(wikiline) {
		if (wikiline.length == 0) {
			return arrow()
		}
		
		var keyword = wikiline.substr(0, 1)
		switch(keyword) {
		case '`':
			return prepare(wikiline.substr(2))
		case '*':
			return activity(wikiline.substr(2))
		case '>':
			return input(wikiline.substr(2))
		case '<':
			return output(wikiline.substr(2))
		default:
			return undefined
		}
	})

	// layout shapes
	var X = paper.width / 2
	var Y = 40
	_.each(shapes, function(shape) {
		if(shape) {
			shape.transform('...T' + X + ',' + Y)
			Y += shape.getBBox().height
		}
	})
	
	// draw arrow between shapes
	$('#edit').focus()
}

render($('#edit').val())

function arrow() { 
	var Y = unit * 4
	var pathString = 'M' + arrowunit + ',0'
	pathString += 'V' + Y
	pathString += 'L0,' + (Y-arrowunit)
	pathString += 'L' + (arrowunit*2) + ',' + (Y-arrowunit)
	pathString += 'L' + arrowunit + ',' + Y
	return paper.path(pathString)
}

function prepare(textSrc) {
	var text = paper.text(0, 0, textSrc).attr({'font-size':fontsize})
	
	var h = text.getBBox().height
	var w = text.getBBox().width	
	var x = -(w/2 + unit)
	var y = -(h/2 + unit)
	var x2 = -x
	var y2 = -y

	var borderPath = 'M' + x + ',' + y
	borderPath += 'L' + x2 + ',' + y
	borderPath += 'L' + (x2+unit) + ',' + 0
	borderPath += 'L' + x2 + ',' + y2
	borderPath += 'L' + x + ',' + y2
	borderPath += 'L' + (x-unit) + ',' + 0
	borderPath += 'L' + x + ',' + y
	var border = paper.path(borderPath)

	var prepare = paper.set()
	prepare.push(text, border)
	
	return prepare
}

function activity(text) {
	var text = paper.text(0, 0, text).attr({'font-size':fontsize})
	
	var h = text.getBBox().height
	var w = text.getBBox().width	
	var x = -(w/2 + unit)
	var y = -(h/2 + unit)
	
	var border = paper.rect(x, y, (w+unit*2), (h+unit*2))
	
	var activity = paper.set()
	activity.push(text, border)
	
	return activity
}

function input(text) {
	var text = paper.text(0, 0, text).attr({'font-size':fontsize})
	
	var h = text.getBBox().height
	var w = text.getBBox().width	
	var x2 = w/2 + unit
	var y2 = h/2 + unit
	var x = -x2
	var y = -y2
	
	var borderPath = 'M' + x + ',' + y
	borderPath += 'L' + x2 + ',' + y
	borderPath += 'L' + (x2+unit) + ',' + 0
	borderPath += 'L' + x2 + ',' + y2
	borderPath += 'L' + x + ',' + y2
	borderPath += 'L' + x + ',' + y
	var border = paper.path(borderPath)
	
	var input = paper.set()
	input.push(text, border)
	
	return input
}

function output(text) {
	return input(text)
}
		</script>
		
		<script language="javascript">
		$.getJSON('githubIssues', function(issues) {
			for (var i=0; i<issues.length; i++) {
				var issue = issues[i]
				$('#issues').append('<li><a href="' + issue.html_url + '">' + issue.title + ' : ' + issue.body + '</a></li>')
			}
		});
		</script>
    </body>
</html>
